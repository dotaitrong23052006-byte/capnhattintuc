<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý Email - Đếm Ngược Tết 2026</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea, #764ba2);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .admin-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
        }

        .admin-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #3498db;
        }

        .admin-header h1 {
            color: #2c3e50;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .admin-header p {
            color: #7f8c8d;
            font-size: 1.1em;
        }

        .sync-status {
            background: #3498db;
            color: white;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
            text-align: center;
        }

        .sync-status.offline {
            background: #e74c3c;
        }

        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .stat-card h3 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .stat-card p {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .stat-card.today {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
        }

        .stat-card.domains {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }

        .email-list {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            max-height: 500px;
            overflow-y: auto;
            margin-bottom: 20px;
        }

        .email-list h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.5em;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .email-count {
            background: #3498db;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8em;
        }

        .email-item {
            background: white;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            border-left: 4px solid #3498db;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s ease;
        }

        .email-item:hover {
            transform: translateX(5px);
        }

        .email-info {
            flex: 1;
        }

        .email-address {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
            font-size: 1.1em;
        }

        .email-meta {
            font-size: 0.8em;
            color: #7f8c8d;
        }

        .email-source {
            display: inline-block;
            background: #ecf0f1;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7em;
            margin-left: 10px;
        }

        .email-actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8em;
            transition: all 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn-delete {
            background: #e74c3c;
            color: white;
        }

        .btn-delete:hover {
            background: #c0392b;
        }

        .btn-export {
            background: #2ecc71;
            color: white;
        }

        .btn-export:hover {
            background: #27ae60;
        }

        .btn-sync {
            background: #9b59b6;
            color: white;
        }

        .btn-sync:hover {
            background: #8e44ad;
        }

        .btn-logout {
            background: #95a5a6;
            color: white;
        }

        .btn-logout:hover {
            background: #7f8c8d;
        }

        .admin-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .back-link {
            display: inline-block;
            margin-top: 20px;
            padding: 10px 20px;
            background: #3498db;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            transition: all 0.3s ease;
            text-align: center;
        }

        .back-link:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }

        .empty-state i {
            font-size: 3em;
            margin-bottom: 20px;
            display: block;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #3498db;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #2ecc71;
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
            max-width: 300px;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.error {
            background: #e74c3c;
        }

        /* Login Screen */
        .login-screen {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 80vh;
        }

        .login-container {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            max-width: 400px;
            width: 90%;
            text-align: center;
        }

        .login-container h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .login-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            margin-bottom: 20px;
            transition: border-color 0.3s ease;
        }

        .login-input:focus {
            outline: none;
            border-color: #3498db;
        }

        .login-input.error {
            border-color: #e74c3c;
        }

        .login-btn {
            width: 100%;
            padding: 15px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .login-btn:hover {
            background: #2980b9;
        }

        .login-error {
            color: #e74c3c;
            font-size: 0.9em;
            margin-top: 10px;
            display: none;
        }

        .login-links {
            margin-top: 20px;
            font-size: 0.9em;
        }

        .login-link {
            color: #3498db;
            text-decoration: none;
        }

        .login-link:hover {
            text-decoration: underline;
        }

        .hidden {
            display: none;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        @media (max-width: 768px) {
            .admin-container {
                padding: 20px;
            }
            
            .admin-header h1 {
                font-size: 2em;
            }
            
            .email-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .email-actions {
                align-self: flex-end;
            }
            
            .admin-actions {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <!-- Login Screen -->
        <div id="login-screen" class="login-screen">
            <div class="login-container">
                <h2>🔐 Đăng nhập Quản lý</h2>
                <p style="color: #7f8c8d; margin-bottom: 20px;">Vui lòng nhập mật khẩu để truy cập trang quản lý</p>
                
                <input type="password" id="login-password" class="login-input" placeholder="Nhập mật khẩu quản lý">
                <div id="login-error" class="login-error">
                    ⚠️ Mật khẩu không đúng. Vui lòng thử lại!
                </div>
                
                <button class="login-btn" id="login-btn">🔓 Đăng nhập</button>
                
                <div class="login-links">
                    <a href="index.html" class="login-link">← Quay lại trang chủ</a>
                </div>
            </div>
        </div>

        <!-- Admin Content (ẩn ban đầu) -->
        <div id="admin-content" class="hidden">
            <div class="admin-header">
                <h1>📊 Quản lý Email Đăng Ký</h1>
                <p>Danh sách những người đã đăng ký nhận tin Tết 2026</p>
                <div class="sync-status" id="sync-status">🟢 Đang kết nối database...</div>
            </div>

            <div class="stats-container">
                <div class="stat-card">
                    <h3 id="total-subscribers">0</h3>
                    <p>Tổng số người đăng ký</p>
                </div>
                <div class="stat-card today">
                    <h3 id="today-subscribers">0</h3>
                    <p>Đăng ký hôm nay</p>
                </div>
                <div class="stat-card domains">
                    <h3 id="unique-domains">0</h3>
                    <p>Domain email khác nhau</p>
                </div>
            </div>

            <div class="admin-actions">
                <button class="btn btn-export" onclick="exportEmails()">📥 Export CSV</button>
                <button class="btn btn-sync" onclick="syncWithFirebase()">🔄 Đồng bộ dữ liệu</button>
                <button class="btn btn-delete" onclick="clearAllEmails()">🗑️ Xóa tất cả</button>
                <button class="btn btn-logout" onclick="logout()">🚪 Đăng xuất</button>
            </div>

            <div class="email-list">
                <h2>
                    📧 Danh sách Email
                    <span class="email-count" id="email-count">0 emails</span>
                </h2>
                <div id="emails-container">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Đang tải dữ liệu...</p>
                    </div>
                </div>
            </div>

            <div style="text-align: center;">
                <a href="index.html" class="back-link">← Quay lại trang chủ</a>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>

    <script>
        // ==================== PASSWORD PROTECTION ====================
        const ADMIN_PASSWORD = "tet2026"; // Mật khẩu mặc định

        // Lấy các element
        const loginScreen = document.getElementById('login-screen');
        const adminContent = document.getElementById('admin-content');
        const loginPasswordInput = document.getElementById('login-password');
        const loginBtn = document.getElementById('login-btn');
        const loginError = document.getElementById('login-error');

        // Kiểm tra nếu đã đăng nhập
        function checkAuthentication() {
            const isAuthenticated = sessionStorage.getItem('adminAuthenticated') === 'true';
            if (isAuthenticated) {
                showAdminContent();
            } else {
                showLoginScreen();
            }
        }

        function showLoginScreen() {
            loginScreen.style.display = 'flex';
            adminContent.classList.add('hidden');
            loginPasswordInput.value = '';
            loginError.style.display = 'none';
            loginPasswordInput.classList.remove('error');
            loginPasswordInput.focus();
        }

        function showAdminContent() {
            loginScreen.style.display = 'none';
            adminContent.classList.remove('hidden');
            initializeAdmin();
        }

        // Xử lý đăng nhập
        loginBtn.addEventListener('click', handleLogin);
        loginPasswordInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                handleLogin();
            }
        });

        function handleLogin() {
            const password = loginPasswordInput.value.trim();
            
            if (password === ADMIN_PASSWORD) {
                // Đăng nhập thành công
                sessionStorage.setItem('adminAuthenticated', 'true');
                showAdminContent();
                showToast('✅ Đăng nhập thành công!', false);
            } else {
                // Đăng nhập thất bại
                loginPasswordInput.classList.add('error');
                loginError.style.display = 'block';
                loginPasswordInput.focus();
                
                // Hiệu ứng shake
                loginPasswordInput.style.animation = 'none';
                setTimeout(() => {
                    loginPasswordInput.style.animation = 'shake 0.5s';
                }, 10);
            }
        }

        function logout() {
            sessionStorage.removeItem('adminAuthenticated');
            showLoginScreen();
            showToast('👋 Đã đăng xuất thành công!', false);
        }

        // ==================== FIREBASE CONFIGURATION ====================
        const firebaseConfig = {
            apiKey: "your-api-key-here",
            authDomain: "your-project.firebaseapp.com",
            projectId: "your-project-id",
            storageBucket: "your-project.appspot.com",
            messagingSenderId: "123456789",
            appId: "your-app-id"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let isOnline = false;
        let allEmails = [];

        // ==================== ADMIN INITIALIZATION ====================
        function initializeAdmin() {
            checkConnection();
            loadEmails();
        }

        // ==================== FIREBASE FUNCTIONS ====================
        async function checkConnection() {
            try {
                await db.collection('newsletter_emails').limit(1).get();
                isOnline = true;
                updateSyncStatus('🟢 Đã kết nối database', true);
                return true;
            } catch (error) {
                isOnline = false;
                updateSyncStatus('🔴 Mất kết nối - Đang dùng dữ liệu local', false);
                return false;
            }
        }

        function updateSyncStatus(message, isOnline) {
            const statusElement = document.getElementById('sync-status');
            statusElement.textContent = message;
            statusElement.className = isOnline ? 'sync-status' : 'sync-status offline';
        }

        async function getEmailsFromFirebase() {
            try {
                const snapshot = await db.collection('newsletter_emails')
                    .orderBy('timestamp', 'desc')
                    .get();
                
                return snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data(),
                    source: 'firebase'
                }));
            } catch (error) {
                console.error('Lỗi khi lấy dữ liệu từ Firebase:', error);
                return [];
            }
        }

        function getEmailsFromLocalStorage() {
            try {
                return JSON.parse(localStorage.getItem('newsletter_emails') || '[]').map(email => ({
                    ...email,
                    source: 'local'
                }));
            } catch (error) {
                console.error('Lỗi khi đọc localStorage:', error);
                return [];
            }
        }

        async function getAllEmails() {
            const firebaseEmails = isOnline ? await getEmailsFromFirebase() : [];
            const localEmails = getEmailsFromLocalStorage();
            
            // Kết hợp và loại bỏ trùng lặp (ưu tiên Firebase)
            const emailMap = new Map();
            
            firebaseEmails.forEach(email => {
                emailMap.set(email.email, email);
            });
            
            localEmails.forEach(email => {
                if (!emailMap.has(email.email)) {
                    emailMap.set(email.email, email);
                }
            });
            
            return Array.from(emailMap.values()).sort((a, b) => 
                new Date(b.timestamp) - new Date(a.timestamp)
            );
        }

        async function deleteEmailFromFirebase(emailId) {
            try {
                await db.collection('newsletter_emails').doc(emailId).delete();
                return true;
            } catch (error) {
                console.error('Lỗi khi xóa email từ Firebase:', error);
                return false;
            }
        }

        function deleteEmailFromLocalStorage(emailId) {
            try {
                let emails = getEmailsFromLocalStorage();
                emails = emails.filter(email => email.id !== emailId);
                localStorage.setItem('newsletter_emails', JSON.stringify(emails));
                return true;
            } catch (error) {
                console.error('Lỗi khi xóa email từ localStorage:', error);
                return false;
            }
        }

        // ==================== SYNC FUNCTIONS ====================
        async function syncWithFirebase() {
            if (!isOnline) {
                showToast('❌ Không có kết nối internet!', true);
                return;
            }

            const localEmails = getEmailsFromLocalStorage();
            let syncedCount = 0;
            let errorCount = 0;

            showToast('🔄 Đang đồng bộ dữ liệu...', false);

            for (const email of localEmails) {
                try {
                    const existing = await db.collection('newsletter_emails')
                        .where('email', '==', email.email)
                        .get();

                    if (existing.empty) {
                        await db.collection('newsletter_emails').add({
                            email: email.email,
                            timestamp: email.timestamp,
                            ip: email.ip || 'unknown',
                            userAgent: email.userAgent || 'unknown',
                            source: 'Đếm Ngược Tết 2026',
                            status: 'active'
                        });
                        syncedCount++;
                    }
                } catch (error) {
                    console.error('Lỗi khi đồng bộ email:', error);
                    errorCount++;
                }
            }

            if (syncedCount > 0) {
                localStorage.removeItem('newsletter_emails');
            }

            let message = '';
            if (syncedCount > 0) {
                message += `✅ Đã đồng bộ ${syncedCount} email lên database! `;
            }
            if (errorCount > 0) {
                message += `❌ ${errorCount} email đồng bộ thất bại.`;
            }
            if (syncedCount === 0 && errorCount === 0) {
                message = '📊 Dữ liệu đã được đồng bộ đầy đủ!';
            }

            showToast(message, errorCount > 0);
            await loadEmails();
        }

        // ==================== DISPLAY FUNCTIONS ====================
        function calculateStats(emails) {
            const today = new Date().toDateString();
            const todaySubscribers = emails.filter(email => 
                new Date(email.timestamp).toDateString() === today
            ).length;
            
            const domains = new Set(emails.map(email => {
                const parts = email.email.split('@');
                return parts.length > 1 ? parts[1] : 'unknown';
            }));
            
            return {
                total: emails.length,
                today: todaySubscribers,
                domains: domains.size
            };
        }

        function displayStats(emails) {
            const stats = calculateStats(emails);
            
            document.getElementById('total-subscribers').textContent = stats.total;
            document.getElementById('today-subscribers').textContent = stats.today;
            document.getElementById('unique-domains').textContent = stats.domains;
            document.getElementById('email-count').textContent = `${stats.total} emails`;
        }

        function displayEmails(emails) {
            const container = document.getElementById('emails-container');
            
            if (emails.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i>📭</i>
                        <h3>Chưa có email nào đăng ký</h3>
                        <p>Người dùng sẽ xuất hiện ở đây khi họ đăng ký nhận tin</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = emails.map((email, index) => `
                <div class="email-item">
                    <div class="email-info">
                        <div class="email-address">
                            ${email.email}
                            <span class="email-source">${email.source}</span>
                        </div>
                        <div class="email-meta">
                            📅 ${new Date(email.timestamp).toLocaleString('vi-VN')}
                            ${email.ip && email.ip !== 'unknown' ? ` • 🌐 ${email.ip}` : ''}
                            ${!isOnline && email.source === 'firebase' ? ' • ⚠️ Chưa đồng bộ' : ''}
                        </div>
                    </div>
                    <div class="email-actions">
                        <button class="btn btn-delete" onclick="deleteEmail('${email.id}', '${email.source}')">
                            🗑️ Xóa
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // ==================== EMAIL MANAGEMENT ====================
        async function deleteEmail(emailId, source) {
            if (!confirm('Bạn có chắc muốn xóa email này?\nHành động này không thể hoàn tác.')) {
                return;
            }

            let success = false;
            
            if (source === 'firebase' && isOnline) {
                success = await deleteEmailFromFirebase(emailId);
            } else {
                success = deleteEmailFromLocalStorage(emailId);
            }

            if (success) {
                showToast('✅ Đã xóa email thành công');
                await loadEmails();
            } else {
                showToast('❌ Lỗi khi xóa email', true);
            }
        }

        async function clearAllEmails() {
            if (!confirm('BẠN CÓ CHẮC MUỐN XÓA TẤT CẢ EMAIL?\n\nHành động này sẽ xóa vĩnh viễn tất cả dữ liệu và không thể hoàn tác!')) {
                return;
            }

            try {
                if (isOnline) {
                    const snapshot = await db.collection('newsletter_emails').get();
                    const deletePromises = snapshot.docs.map(doc => doc.ref.delete());
                    await Promise.all(deletePromises);
                }
                
                localStorage.removeItem('newsletter_emails');
                
                showToast('✅ Đã xóa tất cả email thành công');
                await loadEmails();
            } catch (error) {
                console.error('Lỗi khi xóa tất cả email:', error);
                showToast('❌ Lỗi khi xóa email', true);
            }
        }

        // ==================== EXPORT FUNCTIONS ====================
        function exportEmails() {
            if (allEmails.length === 0) {
                showToast('❌ Không có email nào để export!', true);
                return;
            }
            
            let csv = 'Email,Thời gian đăng ký,IP,Source\n';
            allEmails.forEach(email => {
                const safeEmail = `"${email.email}"`;
                const safeTimestamp = `"${new Date(email.timestamp).toLocaleString('vi-VN')}"`;
                const safeIP = `"${email.ip || 'unknown'}"`;
                const safeSource = `"${email.source}"`;
                csv += `${safeEmail},${safeTimestamp},${safeIP},${safeSource}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            const date = new Date().toISOString().split('T')[0];
            
            link.setAttribute('href', url);
            link.setAttribute('download', `emails-dang-ky-tet-${date}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showToast(`✅ Đã export ${allEmails.length} email thành công`);
        }

        // ==================== TOAST NOTIFICATION ====================
        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast' + (isError ? ' error' : '');
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 4000);
        }

        // ==================== MAIN LOAD FUNCTION ====================
        async function loadEmails() {
            const container = document.getElementById('emails-container');
            container.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Đang tải dữ liệu...</p>
                </div>
            `;

            try {
                allEmails = await getAllEmails();
                displayStats(allEmails);
                displayEmails(allEmails);
            } catch (error) {
                console.error('Lỗi khi tải dữ liệu:', error);
                container.innerHTML = `
                    <div class="empty-state">
                        <i>❌</i>
                        <h3>Lỗi khi tải dữ liệu</h3>
                        <p>Vui lòng thử lại sau</p>
                    </div>
                `;
            }
        }

        // ==================== INITIALIZATION ====================
        document.addEventListener('DOMContentLoaded', function() {
            checkAuthentication();
        });
    </script>
</body>
</html>